<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard - PROPLEDGER</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚õìÔ∏è</text></svg>">
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .messages-badge {
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body>
    <div class="page-container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo-section">
                    <a href="index.html" class="logo">PROPLEDGER</a>
                </div>
                <ul class="nav-links">
                    <li><a href="properties.html">Properties</a></li>
                    <li><a href="investments.html">Investments</a></li>
                    <li><a href="crowdfunding.html">Crowdfunding</a></li>
                    <li><a href="managers.html">Portfolio Managers</a></li>
                    <li><a href="support.html">Support</a></li>
                </ul>
                <div class="auth-buttons">
                    <span id="userWelcome" class="user-welcome">Welcome Agent!</span>
                    <button onclick="logout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="dashboard-container" style="max-width: 1200px; margin: 2rem auto; padding: 2rem;">
            <div class="dashboard-header" style="margin-bottom: 2rem;">
                <h1 style="color: var(--blockchain-blue); margin-bottom: 0.5rem;">Agent Dashboard</h1>
                <p style="color: var(--text-secondary);">Manage your real estate agent profile and client connections
                </p>
            </div>

            <!-- Agent Status Card -->
            <div class="agent-status-card"
                style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
                <div class="blockchain-badge" style="margin-bottom: 1rem;">
                    <span>üè¢</span>
                    Agent Profile Status
                </div>
                <div id="agentInfo"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <!-- Agent info will be populated by JavaScript -->
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                <div class="stat-card"
                    style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 1.5rem; text-align: center;">
                    <div class="stat-icon" style="font-size: 2rem; margin-bottom: 1rem;">üè†</div>
                    <div class="stat-value" style="font-size: 2rem; color: var(--blockchain-blue); font-weight: bold;"
                        id="totalListings">0</div>
                    <div class="stat-label" style="color: var(--text-secondary);">Active Listings</div>
                </div>

                <div class="stat-card"
                    style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 1.5rem; text-align: center;">
                    <div class="stat-icon" style="font-size: 2rem; margin-bottom: 1rem;">üë•</div>
                    <div class="stat-value" style="font-size: 2rem; color: var(--blockchain-blue); font-weight: bold;"
                        id="totalClients">0</div>
                    <div class="stat-label" style="color: var(--text-secondary);">Active Clients</div>
                </div>

                <div class="stat-card"
                    style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 1.5rem; text-align: center;">
                    <div class="stat-icon" style="font-size: 2rem; margin-bottom: 1rem;">üí∞</div>
                    <div class="stat-value" style="font-size: 2rem; color: var(--blockchain-blue); font-weight: bold;"
                        id="totalCommission">‚Ç®0</div>
                    <div class="stat-label" style="color: var(--text-secondary);">Total Commission</div>
                </div>

                <div class="stat-card"
                    style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 1.5rem; text-align: center;">
                    <div class="stat-icon" style="font-size: 2rem; margin-bottom: 1rem;">‚≠ê</div>
                    <div class="stat-value" style="font-size: 2rem; color: var(--blockchain-blue); font-weight: bold;"
                        id="agentRating">0.0</div>
                    <div class="stat-label" style="color: var(--text-secondary);">Agent Rating</div>
                </div>
            </div>

            <!-- Messages Section -->
            <div class="messages-section"
                style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3
                        style="color: var(--blockchain-blue); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        üí¨ Client Messages
                        <span id="messagesBadge" class="messages-badge"
                            style="background: #ff4444; color: white; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.8rem; min-width: 1.5rem; text-align: center; display: none;">0</span>
                    </h3>
                    <button onclick="refreshMessages()" class="btn btn-secondary"
                        style="padding: 0.5rem 1rem; font-size: 0.9rem;">üîÑ Refresh</button>
                </div>

                <div id="messagesContainer" style="max-height: 400px; overflow-y: auto;">
                    <div id="messagesLoading" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        Loading messages...
                    </div>
                </div>
            </div>

            <!-- Video Call Section -->
            <div class="video-call-section"
                style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3
                        style="color: var(--blockchain-blue); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        üìπ Video Calls
                        <span id="videoCallStatus"
                            style="background: #00ff88; color: #000; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">üü¢
                            LIVE</span>
                    </h3>
                    <button onclick="refreshVideoCallHistory()" class="btn btn-secondary"
                        style="padding: 0.5rem 1rem; font-size: 0.9rem;">üîÑ Refresh</button>
                </div>

                <div class="video-call-controls"
                    style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button onclick="startAgentVideoCall()" class="btn btn-primary" style="flex: 1; min-width: 200px;">
                        üìπ Start Video Call with Client
                    </button>
                    <button onclick="scheduleVideoCall()" class="btn btn-secondary" style="flex: 1; min-width: 200px;">
                        üìÖ Schedule Video Meeting
                    </button>
                </div>

                <div id="videoCallHistory" class="video-call-history" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìû</div>
                        <p>No recent video calls</p>
                        <p style="font-size: 0.9rem;">Start a video call with your clients to provide personalized
                            service</p>
                    </div>
                </div>
            </div>

            <!-- Agent Actions -->
            <div class="agent-actions"
                style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem;">
                <h3 style="color: var(--blockchain-blue); margin-bottom: 1.5rem;">Agent Tools</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <a href="properties.html" class="btn btn-primary">Browse Properties</a>
                    <a href="investments.html" class="btn btn-primary">View Investments</a>
                    <a href="crowdfunding.html" class="btn btn-primary">Crowdfunding</a>
                    <a href="managers.html" class="btn btn-primary">Portfolio Managers</a>
                    <a href="support.html" class="btn btn-primary">Get Support</a>
                </div>
            </div>


            <!-- Recent Activity -->
            <div class="recent-activity"
                style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem; margin-top: 2rem;">
                <h3 style="color: var(--blockchain-blue); margin-bottom: 1.5rem;">Recent Activity</h3>
                <div id="recentActivity" style="color: var(--text-secondary);">
                    <p>No recent activity to display.</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>&copy; 2024 PROPLEDGER. All rights reserved.</p>
                <div class="blockchain-badge">
                    <span>üîê</span>
                    Secured by Blockchain Technology
                </div>
            </div>
        </footer>
    </div>

    <script src="js/video-integrations.js"></script>
    <script src="js/video-call-notifications.js"></script>
    <script>
        // Prevent multiple auth checks and main.js conflicts
        let authCheckInProgress = false;
        let pageInitialized = false;

        // Check if user is logged in and is an agent
        async function checkAgentAuth() {
            if (authCheckInProgress || pageInitialized) return;
            authCheckInProgress = true;

            try {
                // Check localStorage first for immediate response
                const localUser = localStorage.getItem('propledger_user');
                if (localUser) {
                    const user = JSON.parse(localUser);
                    console.log('LocalStorage user data:', user);

                    if (user.type !== 'agent' && user.user_type !== 'agent') {
                        console.log('User is not an agent, redirecting to dashboard');
                        // Add delay to prevent rapid redirects
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1000);
                        return;
                    }

                    // Update UI with agent info
                    const welcomeElement = document.getElementById('userWelcome');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Agent: ${user.name || user.full_name}`;
                    }

                    // Load agent-specific data
                    await loadAgentData(user.id);
                    pageInitialized = true;
                    console.log('Agent dashboard initialized from localStorage');
                }

                // Also check server session
                const response = await fetch('../auth/check_session.php');
                const data = await response.json();
                console.log('Server session check result:', data);

                if (data.success) {
                    if (data.user.user_type !== 'agent') {
                        console.log('Server confirms user is not an agent');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1000);
                        return;
                    }

                    // Store user data in localStorage for future use
                    localStorage.setItem('propledger_user', JSON.stringify(data.user));

                    // Update UI with agent info
                    const welcomeElement = document.getElementById('userWelcome');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Agent: ${data.user.full_name}`;
                    }

                    // Load agent-specific data
                    await loadAgentData(data.user.id);
                    pageInitialized = true;
                    console.log('Agent dashboard initialized from server session');
                } else {
                    console.log('No valid session, redirecting to login');
                    // Add delay to prevent rapid redirects
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // Check localStorage as fallback before redirecting
                const localUser = localStorage.getItem('propledger_user');
                if (!localUser) {
                    console.log('No fallback data, redirecting to login');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                }
            } finally {
                authCheckInProgress = false;
            }
        }

        // Load agent-specific data
        async function loadAgentData(userId) {
            try {
                console.log('Loading agent data for user ID:', userId);
                const response = await fetch(`../managers/get_agent_data.php?user_id=${userId}`);
                const data = await response.json();
                console.log('Agent data response:', data);

                if (data.success && data.agent) {
                    const agent = data.agent;

                    // Populate agent info card
                    const agentInfoDiv = document.getElementById('agentInfo');
                    if (agentInfoDiv) {
                        agentInfoDiv.innerHTML = `
                            <div>
                                <strong style="color: var(--blockchain-blue);">License Number:</strong><br>
                                <span style="color: var(--text-light);">${agent.license_number}</span>
                            </div>
                            <div>
                                <strong style="color: var(--blockchain-blue);">Experience:</strong><br>
                                <span style="color: var(--text-light);">${agent.experience}</span>
                            </div>
                            <div>
                                <strong style="color: var(--blockchain-blue);">Specialization:</strong><br>
                                <span style="color: var(--text-light); text-transform: capitalize;">${agent.specialization}</span>
                            </div>
                            <div>
                                <strong style="color: var(--blockchain-blue);">Status:</strong><br>
                                <span style="color: ${agent.status === 'approved' ? '#00ff88' : '#ffa500'}; text-transform: capitalize;">${agent.status}</span>
                            </div>
                            <div>
                                <strong style="color: var(--blockchain-blue);">Online Status:</strong><br>
                                <span id="onlineStatus" style="color: #00ff88; font-weight: bold;">
                                    <span style="display: inline-block; width: 8px; height: 8px; background: #00ff88; border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite;"></span>
                                    Active
                                </span>
                            </div>
                            <div>
                                <strong style="color: var(--blockchain-blue);">City:</strong><br>
                                <span style="color: var(--text-light);">${agent.city}</span>
                            </div>
                            <div>
                                <strong style="color: var(--blockchain-blue);">Agency:</strong><br>
                                <span style="color: var(--text-light);">${agent.agency || 'Independent'}</span>
                            </div>
                        `;
                    }

                    // Update stats
                    const commissionElement = document.getElementById('totalCommission');
                    const ratingElement = document.getElementById('agentRating');

                    if (commissionElement) {
                        commissionElement.textContent = '‚Ç®' + (parseFloat(agent.total_sales) || 0).toLocaleString();
                    }
                    if (ratingElement) {
                        ratingElement.textContent = (parseFloat(agent.rating) || 0.0).toFixed(1);
                    }

                    console.log('Agent data loaded successfully');
                } else {
                    console.error('Failed to load agent data:', data.message);
                    // Show fallback agent info with active status
                    const agentInfoDiv = document.getElementById('agentInfo');
                    if (agentInfoDiv) {
                        agentInfoDiv.innerHTML = `
                            <div class="dashboard-card">
                            <h3>üìä Performance Metrics</h3>
                            <div class="metrics-grid">
                                <div class="metric">
                                    <span class="metric-label">Total Sales</span>
                                    <span class="metric-value" id="totalSales">‚Ç®0</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Commission Earned</span>
                                    <span class="metric-value" id="commissionEarned">‚Ç®0</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Rating</span>
                                    <span class="metric-value" id="agentRating">0.0</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <h3>üí¨ Messages <span id="messageNotificationBadge" class="notification-badge" style="display: none;">0</span></h3>
                            <div id="messagesList" class="messages-container">
                                <p style="color: var(--text-secondary);">Loading messages...</p>
                            </div>
                            <div class="message-actions" style="margin-top: 15px;">
                                <button onclick="refreshMessages()" class="btn-secondary" style="margin-right: 10px;">üîÑ Refresh</button>
                                <button onclick="markAllAsRead()" class="btn-primary">‚úì Mark All Read</button>
                            </div>
                        </div>
                            <div>
                                <strong style="color: var(--blockchain-blue);">Online Status:</strong><br>
                                <span id="onlineStatus" style="color: #00ff88; font-weight: bold;">
                                    <span style="display: inline-block; width: 8px; height: 8px; background: #00ff88; border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite;"></span>
                                    Active
                                </span>
                                <strong style="color: var(--blockchain-blue);">City:</strong><br>
                                <span style="color: var(--text-light);">Not Specified</span>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading agent data:', error);
                // Show fallback agent info with active status even on error
                const agentInfoDiv = document.getElementById('agentInfo');
                if (agentInfoDiv) {
                    agentInfoDiv.innerHTML = `
                        <div>
                            <strong style="color: var(--blockchain-blue);">License Number:</strong><br>
                            <span style="color: var(--text-light);">Pending Registration</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Experience:</strong><br>
                            <span style="color: var(--text-light);">New Agent</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Specialization:</strong><br>
                            <span style="color: var(--text-light);">General Real Estate</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Status:</strong><br>
                            <span style="color: #ffa500; text-transform: capitalize;">Pending</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Online Status:</strong><br>
                            <span id="onlineStatus" style="color: #00ff88; font-weight: bold;">
                                <span style="display: inline-block; width: 8px; height: 8px; background: #00ff88; border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite;"></span>
                                Active
                            </span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">City:</strong><br>
                            <span style="color: var(--text-light);">Not Specified</span>
                        </div>
                    `;
                }
            }
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('../auth/logout_handler.php', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    localStorage.removeItem('propledger_user');
                    localStorage.removeItem('propledger_token_balance');
                    alert('Logged out successfully!');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Logout failed:', error);
                // Force redirect anyway
                localStorage.removeItem('propledger_user');
                localStorage.removeItem('propledger_token_balance');
                window.location.href = 'index.html';
            }
        }

        // Update agent online status in database
        async function updateOnlineStatus() {
            try {
                const localUser = localStorage.getItem('propledger_user');
                if (localUser) {
                    const user = JSON.parse(localUser);
                    if (user.type === 'agent' || user.user_type === 'agent') {
                        await fetch('../managers/update_agent_status.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                user_id: user.id,
                                status: 'online'
                            })
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to update online status:', error);
            }
        }

        // Set agent offline when leaving page
        function setOfflineStatus() {
            const localUser = localStorage.getItem('propledger_user');
            if (localUser) {
                const user = JSON.parse(localUser);
                if (user.type === 'agent' || user.user_type === 'agent') {
                    navigator.sendBeacon('../managers/update_agent_status.php', JSON.stringify({
                        user_id: user.id,
                        status: 'offline'
                    }));
                }
            }
        }


        // Load agent messages
        async function loadMessages() {
            try {
                const response = await fetch('../managers/get_agent_received_messages.php');
                const data = await response.json();

                const messagesContainer = document.getElementById('messagesContainer');
                const messagesBadge = document.getElementById('messagesBadge');
                const messagesLoading = document.getElementById('messagesLoading');

                if (messagesLoading) {
                    messagesLoading.style.display = 'none';
                }

                if (data.success) {
                    // Update badge
                    if (messagesBadge) {
                        if (data.unread_count > 0) {
                            messagesBadge.textContent = data.unread_count;
                            messagesBadge.style.display = 'inline-block';
                        } else {
                            messagesBadge.style.display = 'none';
                        }
                    }

                    // Display messages (user messages received by agent)
                    if (data.messages && data.messages.length > 0) {
                        messagesContainer.innerHTML = data.messages.map(msg => `
                            <div class="message-item" style="border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: ${msg.status === 'unread' ? 'rgba(0, 212, 255, 0.05)' : 'var(--card-bg)'};">
                                <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <h4 style="color: var(--blockchain-blue); margin: 0 0 0.25rem 0; font-size: 1rem;">${msg.subject}</h4>
                                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.85rem;">From: ${msg.sender_name} (${msg.sender_email})</p>
                                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.8rem;">${new Date(msg.created_at).toLocaleString()}</p>
                                    </div>
                                    <span class="message-status" style="padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; background: ${msg.status === 'unread' ? '#ff4444' : msg.status === 'replied' ? '#00ff88' : '#ffa500'}; color: white;">${msg.status.toUpperCase()}</span>
                                </div>
                                <div style="color: var(--text-light); margin-bottom: 1rem; line-height: 1.4;">${msg.message}</div>
                                ${msg.status !== 'replied' ? `
                                    <div class="reply-section" style="border-top: 1px solid rgba(0, 212, 255, 0.1); padding-top: 1rem;">
                                        <textarea id="reply-${msg.id}" placeholder="Type your reply..." style="width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 5px; background: var(--dark-bg); color: var(--text-light); resize: vertical; margin-bottom: 0.5rem;"></textarea>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="sendReply(${msg.id}, ${msg.user_id})" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">üì§ Send Reply</button>
                                            <button onclick="deleteMessage(${msg.id})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Delete</button>
                                        </div>
                                    </div>
                                ` : `
                                    <div style="border-top: 1px solid rgba(0, 212, 255, 0.1); padding-top: 1rem;">
                                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;"><strong>Your Reply:</strong></p>
                                        <p style="color: var(--text-light); margin: 0.5rem 0 0 0; font-style: italic;">${msg.reply_message}</p>
                                        <p style="color: var(--text-secondary); font-size: 0.8rem; margin: 0.5rem 0 0 0;">Replied on: ${new Date(msg.replied_at).toLocaleString()}</p>
                                        <div style="display: flex; justify-content: flex-end; margin-top: 0.5rem;">
                                            <button onclick="deleteMessage(${msg.id})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Delete</button>
                                        </div>
                                    </div>
                                `}
                            </div>
                        `).join('');
                    } else {
                        // Show debug information if no messages
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                                <h4>No messages found</h4>
                                ${data.data ? `
                                    <div style="text-align: left; background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                                        <strong>Debug Info:</strong><br>
                                        Total Messages in DB: ${data.data.total_messages}<br>
                                        Sample Users: ${data.data.sample_users.length}<br>
                                        <details>
                                            <summary>Full Debug Data</summary>
                                            <pre>${JSON.stringify(data.data, null, 2)}</pre>
                                        </details>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                } else {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; color: #ff4444; padding: 2rem;">
                            <h4>Error loading messages: ${data.message}</h4>
                            ${data.debug ? `
                                <div style="text-align: left; background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 5px; margin-top: 1rem; font-size: 0.8rem;">
                                    <strong>Debug Info:</strong><br>
                                    <pre>${JSON.stringify(data.debug, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesContainer').innerHTML = `
                    <div style="text-align: center; color: #ff4444; padding: 2rem;">
                        <h4>Failed to load messages</h4>
                        <p>Error: ${error.message}</p>
                        <div style="margin-top: 1rem;">
                            <a href="../php/quick_setup_messages.php" class="btn btn-primary" style="text-decoration: none; margin-right: 1rem;">üîß Setup Database</a>
                            <button onclick="loadMessages()" class="btn btn-secondary">üîÑ Retry</button>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                            If this is your first time, please run the database setup first.
                        </p>
                    </div>
                `;
            }
        }

        // Send reply to user
        async function sendReply(messageId, userId) {
            const replyTextarea = document.getElementById(`reply-${messageId}`);
            const replyMessage = replyTextarea.value.trim();

            if (!replyMessage) {
                alert('Please enter a reply message.');
                return;
            }

            try {
                const response = await fetch('../managers/send_agent_reply.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message_id: messageId,
                        user_id: userId,
                        reply_message: replyMessage
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('‚úÖ Reply sent successfully!', 'success');
                    loadMessages(); // Refresh messages
                } else {
                    showNotification('‚ùå Failed to send reply: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error sending reply:', error);
                alert('Failed to send reply. Please try again.');
            }
        }

        // Delete message
        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            try {
                const response = await fetch('../managers/delete_message.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message_id: messageId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('üóëÔ∏è Message deleted successfully', 'success');
                    loadMessages(); // Refresh messages
                } else {
                    showNotification('Failed to delete message: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Failed to delete message', 'error');
            }
        }

        // Refresh messages
        function refreshMessages() {
            loadMessages();
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'info' ? 'var(--blockchain-blue)' : type === 'success' ? '#00ff88' : '#ff4444'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 300px;
                font-size: 0.9rem;
                animation: slideIn 0.3s ease-out;
            `;

            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: 1rem;">√ó</button>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Initialize page only once with proper error handling
        function initializePage() {
            console.log('Initializing agent dashboard...');
            console.log('Document ready state:', document.readyState);

            // Prevent multiple initializations
            if (window.agentDashboardInitialized) {
                console.log('Dashboard already initialized, skipping...');
                return;
            }

            window.agentDashboardInitialized = true;
            checkAgentAuth();

            // Load messages
            loadMessages();

            // Auto-refresh messages every 30 seconds
            setInterval(loadMessages, 30000);

            // Update online status when dashboard loads
            updateOnlineStatus();

            // Update online status every 30 seconds
            setInterval(updateOnlineStatus, 30000);

            // Set offline when page unloads
            window.addEventListener('beforeunload', setOfflineStatus);
            window.addEventListener('pagehide', setOfflineStatus);
        }

        // Video call functions for agents
        function startAgentVideoCall() {
            const clientName = prompt('Enter client name to call:');
            if (clientName && clientName.trim()) {
                // Call with additional context that this is agent-initiated
                startJitsiVideoCallAsAgent(clientName.trim());
            }
        }

        // Agent-specific video call function
        function startJitsiVideoCallAsAgent(clientName) {
            const isLoggedIn = localStorage.getItem('propledger_user');

            if (!isLoggedIn) {
                alert('Please login to start video calls.');
                window.location.href = 'login.html';
                return;
            }

            // Generate unique room name
            const roomName = `propledger-agent-${clientName.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}`;
            const currentUser = JSON.parse(localStorage.getItem('propledger_user'));
            const agentName = currentUser.name || currentUser.full_name || 'Agent';

            // Create Jitsi Meet URL
            const jitsiUrl = `https://meet.jit.si/${roomName}?userInfo.displayName=${encodeURIComponent(agentName)}`;

            if (confirm(`Start video call with ${clientName}?\n\nThis will open Jitsi Meet in a new window.`)) {
                // Open Jitsi Meet in new window
                const callWindow = window.open(jitsiUrl, 'jitsi-call', 'width=1200,height=800,scrollbars=yes,resizable=yes');

                // Store call info with agent identification
                const calls = JSON.parse(localStorage.getItem('propledger_calls') || '[]');

                calls.push({
                    agentName: agentName,
                    clientName: clientName,
                    roomName: roomName,
                    type: 'jitsi-meet',
                    startTime: new Date().toISOString(),
                    status: 'active',
                    url: jitsiUrl,
                    // Agent-specific identification
                    initiatedBy: 'agent',
                    agentId: currentUser.id,
                    userName: null,
                    userId: null
                });
                localStorage.setItem('propledger_calls', JSON.stringify(calls));

                // Show notification
                showCallNotification(`Video call started with ${clientName}`, 'Room: ' + roomName);
            }
        }

        function scheduleVideoCall() {
            alert('Video call scheduling feature coming soon!\n\nFor now, you can:\n1. Send a message to your client\n2. Include a meeting time\n3. Start the video call at the scheduled time');
        }

        function refreshVideoCallHistory() {
            const videoCallHistory = document.getElementById('videoCallHistory');
            const allCalls = JSON.parse(localStorage.getItem('propledger_calls') || '[]');

            // Get current agent info
            const currentUser = JSON.parse(localStorage.getItem('propledger_user') || '{}');
            const currentAgentName = currentUser.name || currentUser.full_name || '';

            // Filter calls for this specific agent only
            const agentCalls = allCalls.filter(call => {
                // Show calls where this agent is the recipient or initiator
                return (call.agentName && call.agentName.toLowerCase().includes(currentAgentName.toLowerCase())) ||
                    (call.initiatedBy === 'agent' && call.agentId === currentUser.id) ||
                    (call.receivedBy === 'agent' && call.agentId === currentUser.id);
            });

            if (agentCalls.length > 0) {
                videoCallHistory.innerHTML = agentCalls.slice(-5).reverse().map(call => `
                    <div style="border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--card-bg);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4 style="color: var(--blockchain-blue); margin: 0; font-size: 1rem;">üìπ ${call.clientName || call.userName || 'Client'}</h4>
                            <span style="color: var(--text-secondary); font-size: 0.8rem;">${new Date(call.startTime).toLocaleString()}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            Type: ${call.type || 'Video Call'} | Status: ${call.status || 'Completed'}
                        </div>
                        ${call.roomName ? `<div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.5rem;">Room: ${call.roomName}</div>` : ''}
                    </div>
                `).join('');
            } else {
                videoCallHistory.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìû</div>
                        <p>No recent video calls</p>
                        <p style="font-size: 0.9rem;">Start a video call with your clients to provide personalized service</p>
                    </div>
                `;
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>

</html>