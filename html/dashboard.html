<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PROPLEDGER</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚õìÔ∏è</text></svg>">
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .messages-badge {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="logo">PROPLEDGER</a>
                <ul class="nav-links">
                    <li><a href="investments.html">Investments</a></li>
                    <li><a href="properties.html">Properties</a></li>
                    <li><a href="crowdfunding.html">Crowdfunding</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="support.html">Support</a></li>
                </ul>
                <div class="auth-buttons">
                    <span id="userWelcome" class="user-welcome">Welcome!</span>
                    <button onclick="logout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="dashboard-container" style="max-width: 1200px; margin: 2rem auto; padding: 2rem;">
            <div class="dashboard-header" style="margin-bottom: 2rem;">
                <h1 style="color: var(--blockchain-blue); margin-bottom: 0.5rem;">Your PROPLEDGER Dashboard</h1>
                <p style="color: var(--text-secondary);">Manage your blockchain real estate investments</p>
            </div>

            <!-- User Info Card -->
            <div class="user-info-card" style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
                <div class="blockchain-badge" style="margin-bottom: 1rem;">
                    <span>üë§</span>
                    Account Information
                </div>
                <div id="userInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <!-- User info will be populated by JavaScript -->
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                <div class="stat-card" style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 1.5rem; text-align: center;">
                    <span style="font-size: 2rem; display: block; margin-bottom: 1rem;">üè†</span>
                    <h3 style="color: var(--blockchain-blue); margin-bottom: 0.5rem;">Properties</h3>
                    <p style="font-size: 2rem; font-weight: bold; color: var(--text-light); margin: 0;">0</p>
                    <small style="color: var(--text-secondary);">Owned Properties</small>
                </div>
                
                <div class="stat-card" style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 1.5rem; text-align: center;">
                    <span style="font-size: 2rem; display: block; margin-bottom: 1rem;">üí∞</span>
                    <h3 style="color: var(--blockchain-blue); margin-bottom: 0.5rem;">Tokens</h3>
                    <p id="userTokenBalance" style="font-size: 2rem; font-weight: bold; color: var(--text-light); margin: 0;">395</p>
                    <small style="color: var(--text-secondary);">Total Tokens</small>
                    <button onclick="openTokenPurchaseModal()" class="btn btn-success" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">üí≥ Buy More</button>
                </div>
                
                <div class="stat-card" style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 1.5rem; text-align: center;">
                    <span style="font-size: 2rem; display: block; margin-bottom: 1rem;">üìà</span>
                    <h3 style="color: var(--blockchain-blue); margin-bottom: 0.5rem;">ROI</h3>
                    <p style="font-size: 2rem; font-weight: bold; color: var(--text-light); margin: 0;">0%</p>
                    <small style="color: var(--text-secondary);">Return on Investment</small>
                </div>
            </div>

            <!-- Token Purchase Section -->
            <div class="token-purchase-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(0, 212, 255, 0.1) 100%); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h3 style="color: var(--blockchain-blue); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üí≥</span> Purchase PROP Tokens
                        </h3>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.95rem;">
                            Expand your investment power with more PROP tokens. Current rate: 1 PROP = ‚Ç®1,000
                        </p>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="openTokenPurchaseModal()" class="btn btn-success" style="font-size: 1.1rem; padding: 1rem 2rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                            <span style="margin-right: 0.5rem;">ü™ô</span>
                            Buy Tokens Now
                        </button>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                            Multiple payment methods available
                        </div>
                    </div>
                </div>
            </div>


            <!-- Messages Section -->
            <div class="messages-section" style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--blockchain-blue); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        üí¨ Agent Messages
                        <span id="messagesBadge" class="messages-badge" style="background: #ff4444; color: white; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.8rem; min-width: 1.5rem; text-align: center; display: none;">0</span>
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="refreshUserMessages()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">üîÑ Refresh</button>
                        <a href="managers.html" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem; text-decoration: none;">üì§ Send Message</a>
                    </div>
                </div>
                
                <div id="userMessagesContainer" style="max-height: 400px; overflow-y: auto;">
                    <div id="userMessagesLoading" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        Loading messages...
                    </div>
                </div>
            </div>

            <!-- Video Call Section -->
            <div class="video-call-section" style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--blockchain-blue); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        üìπ Video Calls with Agents
                        <span id="videoCallStatus" style="background: #00ff88; color: #000; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">üü¢ LIVE</span>
                    </h3>
                    <button onclick="refreshUserVideoCallHistory()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">üîÑ Refresh</button>
                </div>
                
                <div class="video-call-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button onclick="startUserVideoCall()" class="btn btn-primary" style="flex: 1; min-width: 200px;">
                        üìπ Call Portfolio Manager
                    </button>
                    <button onclick="requestVideoMeeting()" class="btn btn-secondary" style="flex: 1; min-width: 200px;">
                        üìÖ Request Meeting
                    </button>
                </div>
                
                <div id="userVideoCallHistory" class="video-call-history" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìû</div>
                        <p>No recent video calls</p>
                        <p style="font-size: 0.9rem;">Connect with your portfolio manager via video call for personalized advice</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions" style="background: var(--card-bg); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 10px; padding: 2rem;">
                <h3 style="color: var(--blockchain-blue); margin-bottom: 1.5rem;">Quick Actions</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <a href="properties.html" class="btn btn-primary">Browse Properties</a>
                    <a href="investments.html" class="btn btn-primary">View Investments</a>
                    <a href="managers.html" class="btn btn-primary">Portfolio Managers</a>
                    <a href="support.html" class="btn btn-primary">Get Support</a>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>&copy; 2024 PROPLEDGER. All rights reserved.</p>
                <div class="blockchain-badge">
                    <span>üîê</span>
                    Secured by Blockchain Technology
                </div>
            </div>
        </footer>
    </div>

    <script src="js/main.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/video-integrations.js"></script>
    <script src="js/video-call-notifications.js"></script>
    <script>
        // Check if user is logged in
        async function checkAuth() {
            try {
                // Check localStorage first for immediate response
                const localUser = localStorage.getItem('propledger_user');
                if (localUser) {
                    const user = JSON.parse(localUser);
                    // Update UI with user info
                    document.getElementById('userWelcome').textContent = `Welcome, ${user.name || user.full_name}!`;
                    
                    // Populate user info card
                    const userInfoDiv = document.getElementById('userInfo');
                    userInfoDiv.innerHTML = `
                        <div>
                            <strong style="color: var(--blockchain-blue);">Name:</strong><br>
                            <span style="color: var(--text-light);">${user.name || user.full_name}</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Email:</strong><br>
                            <span style="color: var(--text-light);">${user.email}</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Account Type:</strong><br>
                            <span style="color: var(--text-light); text-transform: capitalize;">${(user.type || user.user_type || 'investor').replace('_', ' ')}</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Status:</strong><br>
                            <span style="color: #00ff88;">Active</span>
                        </div>
                    `;
                    return;
                }

                // Fallback to server check if no localStorage data
                const response = await fetch('../auth/check_session.php');
                const data = await response.json();
                
                if (data.success) {
                    // Store user data in localStorage for future use
                    localStorage.setItem('propledger_user', JSON.stringify(data.user));
                    
                    // Update UI with user info
                    document.getElementById('userWelcome').textContent = `Welcome, ${data.user.full_name}!`;
                    
                    // Populate user info card
                    const userInfoDiv = document.getElementById('userInfo');
                    userInfoDiv.innerHTML = `
                        <div>
                            <strong style="color: var(--blockchain-blue);">Name:</strong><br>
                            <span style="color: var(--text-light);">${data.user.full_name}</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Email:</strong><br>
                            <span style="color: var(--text-light);">${data.user.email}</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Account Type:</strong><br>
                            <span style="color: var(--text-light); text-transform: capitalize;">${data.user.user_type.replace('_', ' ')}</span>
                        </div>
                        <div>
                            <strong style="color: var(--blockchain-blue);">Status:</strong><br>
                            <span style="color: #00ff88;">Active</span>
                        </div>
                    `;
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // Check localStorage as fallback before redirecting
                const localUser = localStorage.getItem('propledger_user');
                if (!localUser) {
                    window.location.href = 'login.html';
                }
            }
        }
        
        // Logout function
        async function logout() {
            try {
                const response = await fetch('../auth/logout_handler.php', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    localStorage.removeItem('propledger_user');
                    localStorage.removeItem('propledger_token_balance');
                    alert('Logged out successfully!');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Logout failed:', error);
                // Force redirect anyway
                localStorage.removeItem('propledger_user');
                localStorage.removeItem('propledger_token_balance');
                window.location.href = 'index.html';
            }
        }
        
        // Load user token balance
        function loadTokenBalance() {
            const savedBalance = localStorage.getItem('propledger_token_balance') || '395';
            const tokenBalanceElement = document.getElementById('userTokenBalance');
            if (tokenBalanceElement) {
                tokenBalanceElement.textContent = savedBalance;
            }
        }
        
        // Load user messages
        async function loadUserMessages() {
            try {
                const response = await fetch('../managers/get_user_received_messages.php');
                const data = await response.json();
                
                const messagesContainer = document.getElementById('userMessagesContainer');
                const messagesBadge = document.getElementById('messagesBadge');
                const messagesLoading = document.getElementById('userMessagesLoading');
                
                if (messagesLoading) {
                    messagesLoading.style.display = 'none';
                }
                
                if (data.success) {
                    // Update badge for unread messages from agents
                    if (messagesBadge) {
                        if (data.unread_count > 0) {
                            messagesBadge.textContent = data.unread_count;
                            messagesBadge.style.display = 'inline-block';
                        } else {
                            messagesBadge.style.display = 'none';
                        }
                    }
                    
                    // Display messages (agent replies received by user)
                    if (data.messages && data.messages.length > 0) {
                        messagesContainer.innerHTML = data.messages.map(msg => `
                            <div class="message-item" style="border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: ${msg.status === 'unread' ? 'rgba(0, 212, 255, 0.05)' : 'var(--card-bg)'}; border-left: 4px solid #0099cc;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <h4 style="color: var(--blockchain-blue); margin: 0 0 0.25rem 0; font-size: 1rem;">${msg.subject}</h4>
                                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.85rem;">
                                            From Agent: ${msg.manager_name}
                                        </p>
                                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.8rem;">${new Date(msg.created_at).toLocaleString()}</p>
                                    </div>
                                    <span class="message-status" style="padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; background: ${msg.status === 'unread' ? '#ff4444' : msg.status === 'replied' ? '#00ff88' : '#ffa500'}; color: white;">${msg.status.toUpperCase()}</span>
                                </div>
                                <div style="color: var(--text-light); margin-bottom: 1rem; line-height: 1.4;">${msg.message}</div>
                                ${msg.status === 'unread' ? `
                                    <div class="reply-section" style="border-top: 1px solid rgba(0, 212, 255, 0.1); padding-top: 1rem;">
                                        <textarea id="user-reply-${msg.id}" placeholder="Type your reply..." style="width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 5px; background: var(--dark-bg); color: var(--text-light); resize: vertical; margin-bottom: 0.5rem;"></textarea>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="sendUserReply(${msg.id}, '${msg.manager_name}')" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">üì§ Send Reply</button>
                                            <button onclick="markAsRead(${msg.id})" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">‚úì Mark as Read</button>
                                            <button onclick="deleteMessage(${msg.id})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Delete</button>
                                        </div>
                                    </div>
                                ` : `
                                    <div style="border-top: 1px solid rgba(0, 212, 255, 0.1); padding-top: 1rem; display: flex; justify-content: flex-end;">
                                        <button onclick="deleteMessage(${msg.id})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Delete</button>
                                    </div>
                                `}
                            </div>
                        `).join('');
                    } else {
                        // Show debug information if no messages
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                                <h4>No messages found</h4>
                                <p><a href="managers.html" style="color: var(--blockchain-blue);">Send your first message to an agent!</a></p>
                                ${data.data ? `
                                    <div style="text-align: left; background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                                        <strong>Debug Info:</strong><br>
                                        Total Messages in DB: ${data.data.total_messages}<br>
                                        Sample Users: ${data.data.sample_users.length}<br>
                                        <details>
                                            <summary>Full Debug Data</summary>
                                            <pre>${JSON.stringify(data.data, null, 2)}</pre>
                                        </details>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                } else {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; color: #ff4444; padding: 2rem;">
                            <h4>Error loading messages: ${data.message}</h4>
                            ${data.debug ? `
                                <div style="text-align: left; background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 5px; margin-top: 1rem; font-size: 0.8rem;">
                                    <strong>Debug Info:</strong><br>
                                    <pre>${JSON.stringify(data.debug, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user messages:', error);
                document.getElementById('userMessagesContainer').innerHTML = `
                    <div style="text-align: center; color: #ff4444; padding: 2rem;">
                        <h4>Failed to load messages</h4>
                        <p>Error: ${error.message}</p>
                        <div style="margin-top: 1rem;">
                            <a href="../php/quick_setup_messages.php" class="btn btn-primary" style="text-decoration: none; margin-right: 1rem;">üîß Setup Database</a>
                            <button onclick="loadUserMessages()" class="btn btn-secondary">üîÑ Retry</button>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                            If this is your first time, please run the database setup first.
                        </p>
                    </div>
                `;
            }
        }

        // Send reply to agent
        async function sendUserReply(messageId, agentName) {
            const replyTextarea = document.getElementById(`user-reply-${messageId}`);
            const replyMessage = replyTextarea.value.trim();
            
            if (!replyMessage) {
                alert('Please enter a reply message.');
                return;
            }
            
            try {
                const response = await fetch('../managers/send_message.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        manager: agentName,
                        subject: 'Re: Message Reply',
                        message: replyMessage,
                        priority: 'normal'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Reply sent successfully!', 'success');
                    loadUserMessages(); // Refresh messages
                } else {
                    showNotification('‚ùå Failed to send reply: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error sending reply:', error);
                alert('Failed to send reply. Please try again.');
            }
        }

        // Mark message as read
        async function markAsRead(messageId) {
            try {
                const response = await fetch('../managers/mark_message_read.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message_id: messageId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úì Message marked as read', 'success');
                    loadUserMessages(); // Refresh messages
                } else {
                    showNotification('Failed to mark as read: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error marking message as read:', error);
                showNotification('Failed to mark message as read', 'error');
            }
        }

        // Delete message
        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }
            
            try {
                const response = await fetch('../managers/delete_message.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message_id: messageId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('üóëÔ∏è Message deleted successfully', 'success');
                    loadUserMessages(); // Refresh messages
                } else {
                    showNotification('Failed to delete message: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Failed to delete message', 'error');
            }
        }

        // Refresh user messages
        function refreshUserMessages() {
            loadUserMessages();
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'info' ? 'var(--blockchain-blue)' : type === 'success' ? '#00ff88' : '#ff4444'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 300px;
                font-size: 0.9rem;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: 1rem;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Video call functions for users
        function startUserVideoCall() {
            const agentName = prompt('Enter agent name to call (or leave blank for any available agent):');
            const callWith = agentName && agentName.trim() ? agentName.trim() : 'Portfolio Manager';
            startJitsiVideoCallAsUser(callWith);
        }

        // User-specific video call function
        function startJitsiVideoCallAsUser(agentName) {
            const isLoggedIn = localStorage.getItem('propledger_user');
            
            if (!isLoggedIn) {
                alert('Please login to start video calls.');
                window.location.href = 'login.html';
                return;
            }
            
            // Generate unique room name
            const roomName = `propledger-user-${agentName.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}`;
            const currentUser = JSON.parse(localStorage.getItem('propledger_user'));
            const userName = currentUser.name || currentUser.full_name || 'User';
            
            // Create Jitsi Meet URL
            const jitsiUrl = `https://meet.jit.si/${roomName}?userInfo.displayName=${encodeURIComponent(userName)}`;
            
            if (confirm(`Start video call with ${agentName}?\n\nThis will open Jitsi Meet in a new window.`)) {
                // Open Jitsi Meet in new window
                const callWindow = window.open(jitsiUrl, 'jitsi-call', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                
                // Store call info with user identification
                const calls = JSON.parse(localStorage.getItem('propledger_calls') || '[]');
                
                calls.push({
                    agentName: agentName,
                    clientName: userName,
                    roomName: roomName,
                    type: 'jitsi-meet',
                    startTime: new Date().toISOString(),
                    status: 'active',
                    url: jitsiUrl,
                    // User-specific identification
                    initiatedBy: 'user',
                    userId: currentUser.id,
                    userName: userName,
                    agentId: null
                });
                localStorage.setItem('propledger_calls', JSON.stringify(calls));
                
                // Show notification
                showCallNotification(`Video call started with ${agentName}`, 'Room: ' + roomName);
            }
        }

        function requestVideoMeeting() {
            alert('Video meeting request feature coming soon!\n\nFor now, you can:\n1. Send a message to your agent requesting a meeting\n2. Include your preferred time\n3. Wait for agent confirmation\n4. Start the video call at the scheduled time');
        }

        function refreshUserVideoCallHistory() {
            const videoCallHistory = document.getElementById('userVideoCallHistory');
            const allCalls = JSON.parse(localStorage.getItem('propledger_calls') || '[]');
            
            // Get current user info
            const currentUser = JSON.parse(localStorage.getItem('propledger_user') || '{}');
            const currentUserName = currentUser.name || currentUser.full_name || '';
            const currentUserId = currentUser.id;
            
            // Filter calls for this specific user only
            const userCalls = allCalls.filter(call => {
                // Show calls where this user is the initiator or participant
                return (call.userName && call.userName.toLowerCase().includes(currentUserName.toLowerCase())) ||
                       (call.initiatedBy === 'user' && call.userId === currentUserId) ||
                       (call.receivedBy === 'user' && call.userId === currentUserId) ||
                       (call.clientName && call.clientName.toLowerCase().includes(currentUserName.toLowerCase()));
            });
            
            if (userCalls.length > 0) {
                videoCallHistory.innerHTML = userCalls.slice(-5).reverse().map(call => `
                    <div style="border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--card-bg);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4 style="color: var(--blockchain-blue); margin: 0; font-size: 1rem;">üìπ ${call.agentName || 'Portfolio Manager'}</h4>
                            <span style="color: var(--text-secondary); font-size: 0.8rem;">${new Date(call.startTime).toLocaleString()}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            Type: ${call.type || 'Video Call'} | Status: ${call.status || 'Completed'}
                        </div>
                        ${call.roomName ? `<div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.5rem;">Room: ${call.roomName}</div>` : ''}
                    </div>
                `).join('');
            } else {
                videoCallHistory.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìû</div>
                        <p>No recent video calls</p>
                        <p style="font-size: 0.9rem;">Connect with your portfolio manager via video call for personalized advice</p>
                    </div>
                `;
            }
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadTokenBalance();
            loadUserMessages();
            
            // Auto-refresh messages every 30 seconds
            setInterval(loadUserMessages, 30000);
        });
    </script>
</body>
</html>
